https://kubernetes.io/blog/2019/01/15/container-storage-interface-ga/
https://aws.amazon.com/premiumsupport/knowledge-center/eks-persistent-storage/



#download the policy from github
curl -o example-iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/v0.9.0/docs/example-iam-policy.json

#create the policy based on the JSON downloaded
aws iam create-policy --policy-name AmazonEKS_EBS_CSI_Driver_Policy --policy-document file://example-iam-policy.json

#create the role to use the policy
aws iam create-role \
  --role-name AmazonEKS_EBS_CSI_DriverRole \
  --assume-role-policy-document file://"trust-policy.json"


# activate the OIDC auth in the cluster
eksctl utils associate-iam-oidc-provider --cluster vcc-eksctl --approve

#create the service account
eksctl create iamserviceaccount \
  --cluster=vcc-eksctl \
  --namespace=kube-system \
  --name=ebs-csi-controller-sa \
  --role-name "EKSEBSCSIDriverRole" \
  --attach-policy-arn=arn:aws:iam::620241740192:policy/AmazonEKS_EBS_CSI_Driver_Policy \
  --approve



#apply using a template from githut
kubectl apply -k "github.com/kubernetes-sigs/aws-ebs-csi-driver/deploy/kubernetes/overlays/stable/?ref=master"


######in case the service account didn't create the annotations###########
kubectl annotate serviceaccount ebs-csi-controller-sa \
  -n kube-system \
  eks.amazonaws.com/role-arn=arn:aws:iam::620241740192:role/EKSEBSCSIDriverRole

kubectl delete pods \
  -n kube-system \
  -l=app=ebs-csi-controller

##########################################################################
